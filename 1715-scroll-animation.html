<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>1715 Fleet Route Slide</title>

<link rel="stylesheet"
  href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.29/"></script>

<style>
  html, body, #viewDiv {
    margin:0;
    padding:0;
    height:100%;
    width:100%;
  }
</style>
</head>

<body>
<div id="viewDiv"></div>

<script>
require([
  "esri/WebMap",
  "esri/views/MapView",
  "esri/Graphic",
  "esri/geometry/geometryEngineAsync"
], function(WebMap, MapView, Graphic, geometryEngineAsync) {

  // -----------------------------
  // GET PARAMETERS FROM QUERY STRING
  // -----------------------------
  const urlParams = new URLSearchParams(window.location.search);

  const OBJECTID = parseInt(urlParams.get("objectid") || "6");
  const CENTER  = urlParams.get("center") || "-79,25"; // lon,lat
  const ZOOM    = parseFloat(urlParams.get("zoom") || "6");
  const DURATION = parseInt(urlParams.get("duration") || "2000"); // milliseconds

  const [lon, lat] = CENTER.split(",").map(Number);

  const webmap = new WebMap({
    portalItem: { id: "8a1ca0f2e04941f895149c09fcc956df" }
  });

  const view = new MapView({
    container: "viewDiv",
    map: webmap,
    center: [lon, lat],
    zoom: ZOOM
  });

  let routeGraphic;
  let densifiedLine;

  // -----------------------------
  // DRAW FUNCTIONS
  // -----------------------------
  function drawToPercent(percent) {
    if (!densifiedLine) return;
    percent = Math.max(0, Math.min(percent, 1));
    const path = densifiedLine.paths[0];
    const index = Math.min(Math.floor(path.length * percent), path.length - 1);
    routeGraphic.geometry = {
      type: "polyline",
      paths: [path.slice(0, index + 1)],
      spatialReference: densifiedLine.spatialReference
    };
  }

  function animateTo(startPercent, endPercent, duration) {
    const startTime = performance.now();
    function step(ts) {
      const progress = Math.min((ts - startTime) / duration, 1);
      drawToPercent(startPercent + (endPercent - startPercent) * progress);
      if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function playAnimation() {
    animateTo(0, 1, DURATION);
  }

  // -----------------------------
  // LOAD ROUTE AND TRIGGER ANIMATION
  // -----------------------------
  view.when(async () => {
    const routeLayer = webmap.layers.find(l => l.title === "1715_routes");
    const result = await routeLayer.queryFeatures({
      where: `OBJECTID = ${OBJECTID}`,
      returnGeometry: true,
      outFields: ["*"]
    });

    if (!result.features.length) {
      console.error("Feature not found:", OBJECTID);
      return;
    }

    const fullLine = result.features[0].geometry;

    densifiedLine = await geometryEngineAsync.densify(fullLine, 2000, "meters");

    const symbol = routeLayer.renderer.getSymbol(result.features[0]);

    routeGraphic = new Graphic({
      geometry: null,
      symbol: symbol
    });

    view.graphics.add(routeGraphic);
    routeLayer.visible = false;

    // Play animation with short delay to ensure the slide is visible
    setTimeout(() => {
      playAnimation();
    }, 200);
  });

</script>
</body>
</html>
